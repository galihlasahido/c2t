#include <stdio.h>
#include <stdlib.h>
#include "iso8583.h"
#include "iso8583_std.h"

char authreq[] = {
0x31,0x31,0x30,0x30,0x70,0x14,0x05,0xC2,0x00,0xE2,0x80,0x00,0x31,0x31,0x31,0x32,
0x33,0x34,0x30,0x34,0x32,0x35,0x37,0x34,0x38,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x31,0x32,0x30,0x30,0x39,0x39,0x30,0x32,0x31,
0x39,0x31,0x34,0x32,0x32,0x30,0x30,0x30,0x39,0x31,0x31,0x4B,0x30,0x30,0x35,0x30,
0x30,0x4B,0x30,0x30,0x31,0x33,0x30,0x31,0x30,0x30,0x30,0x30,0x30,0x30,0x35,0x39,
0x36,0x34,0x30,0x31,0x38,0x37,0x37,0x37,0x20,0x20,0x20,0x20,0x20,0x31,0x39,0x37,
0x38,0x35,0x35,0x31,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x34,0x34,0x50,0x42,
0x53,0x20,0x49,0x4E,0x54,0x45,0x52,0x4E,0x41,0x4C,0x20,0x54,0x45,0x53,0x54,0x5C,
0x5C,0x42,0x61,0x6C,0x6C,0x65,0x72,0x75,0x70,0x5C,0x32,0x37,0x35,0x30,0x20,0x20,
0x20,0x20,0x20,0x20,0x44,0x4B,0x20,0x44,0x4E,0x4B,0x30,0x30,0x33,0x20,0x20,0x20,
0x44,0x4B,0x4B
};

char authresp[] = {
0x31,0x31,0x31,0x30,0x70,0x10,0x00,0x02,0x06,0xC0,0x81,0x00,0x31,0x36,0x35,0x30,
0x31,0x39,0x31,0x32,0x33,0x34,0x30,0x34,0x32,0x35,0x37,0x34,0x38,0x33,0x30,0x30,
0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x31,0x32,0x30,0x30,
0x39,0x39,0x30,0x32,0x31,0x39,0x31,0x34,0x32,0x32,0x30,0x30,0x30,0x31,0x38,0x31,
0x34,0x32,0x36,0x32,0x38,0x30,0x30,0x30,0x37,0x37,0x37,0x20,0x20,0x20,0x20,0x20,
0x31,0x39,0x37,0x38,0x35,0x35,0x31,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x44,
0x4B,0x4B,0x30,0x39,0x30,0x30,0x38,0x73,0x6F,0x66,0x74,0x77,0x61,0x72,0x65,0x57,
0x34,0x70,0x68,0xC2,0x0C,0x68,0x15,0x92,0xAC,0x32,0x60,0x20,0x5D,0x26,0xD2,0xDA,
0xC9,0xD4,0xBB,0x12,0xBB,0xAB,0x75,0x54,0xF3,0x56,0xCB,0x15,0x86,0x2F,0x2D,0x85,
0xEA,0x8A,0x40,0xE7,0xA6,0x22,0xB1,0x88,0xA2,0xCF,0xCF,0x55,0x46,0x4B,0x7A,0xB8,
0xEE,0x6D,0xAD,0xA6,0xDE,0x61,0xBF,0xFB,0x51,0x75,0x34,0xF8,0x10,0xD6,0xBB,0xB3,
0xE4,0x98,0x9C,0x2A,0xF8,0x74,0x72,0xE7,0xAC,0xDA,0x95,0xB3,0xE0,0xD4,0xEE,0x00,
0x00,0x00,0x00,0x00,0x00,0x00
};

char capreq[] = {
0x31,0x32,0x32,0x30,0x70,0x14,
0x05,0x42,0x06,0xE2,0x81,0x00,0x31,0x36,0x35,0x30,0x31,0x39,0x31,0x32,0x33,0x34,
0x30,0x34,0x32,0x35,0x37,0x34,0x38,0x33,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
0x30,0x30,0x30,0x30,0x30,0x30,0x31,0x32,0x30,0x30,0x39,0x39,0x30,0x32,0x31,0x39,
0x31,0x34,0x32,0x32,0x34,0x35,0x30,0x39,0x31,0x31,0x4B,0x30,0x30,0x35,0x30,0x30,
0x4B,0x30,0x30,0x31,0x33,0x30,0x32,0x30,0x31,0x35,0x39,0x36,0x34,0x30,0x31,0x38,
0x31,0x34,0x32,0x36,0x32,0x38,0x30,0x30,0x30,0x37,0x37,0x37,0x20,0x20,0x20,0x20,
0x20,0x31,0x39,0x37,0x38,0x35,0x35,0x31,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x34,0x34,0x50,0x42,0x53,0x20,0x49,0x4E,0x54,0x45,0x52,0x4E,0x41,0x4C,0x20,0x54,
0x45,0x53,0x54,0x5C,0x5C,0x42,0x61,0x6C,0x6C,0x65,0x72,0x75,0x70,0x5C,0x32,0x37,
0x35,0x30,0x20,0x20,0x20,0x20,0x20,0x20,0x44,0x4B,0x20,0x44,0x4E,0x4B,0x30,0x32,
0x37,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x44,0x4B,0x4B,0x30,
0x39,0x30,0x30,0x38,0x73,0x6F,0x66,0x74,0x77,0x61,0x72,0x65,0x57,0x34,0x70,0x68,
0xC2,0x0C,0x68,0x15,0x92,0xAC,0x32,0x60,0x20,0x5D,0x26,0xD2,0xDA,0xC9,0xD4,0xBB,
0x12,0xBB,0xAB,0x75,0x54,0xF3,0x56,0xCB,0x15,0x86,0x2F,0x2D,0x85,0xEA,0x8A,0x40,
0xE7,0xA6,0x22,0xB1,0x88,0xA2,0xCF,0xCF,0x55,0x46,0x4B,0x7A,0xB8,0xEE,0x6D,0xAD,
0xA6,0xDE,0x61,0xBF,0xFB,0x51,0x75,0x34,0xF8,0x10,0xD6,0xBB,0xB3,0xE4,0x98,0x9C,
0x2A,0xF8,0x74,0x72,0xE7,0xAC,0xDA,0x95,0xB3,0xE0,0xD4,0xEE,0x00,0x00,0x00,0x00
};

char capresp[] = {
0x31,0x32,0x33,0x30,0x70,0x10,
0x00,0x02,0x02,0xC0,0x81,0x00,0x31,0x36,0x35,0x30,0x31,0x39,0x31,0x32,0x33,0x34,
0x30,0x34,0x32,0x35,0x37,0x34,0x38,0x33,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
0x30,0x30,0x30,0x30,0x30,0x30,0x31,0x32,0x30,0x30,0x39,0x39,0x30,0x32,0x31,0x39,
0x31,0x34,0x32,0x32,0x34,0x35,0x30,0x31,0x38,0x30,0x30,0x30,0x37,0x37,0x37,0x20,
0x20,0x20,0x20,0x20,0x31,0x39,0x37,0x38,0x35,0x35,0x31,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x44,0x4B,0x4B,0x30,0x39,0x30,0x30,0x38,0x73,0x6F,0x66,0x74,0x77,
0x61,0x72,0x65,0x57,0x34,0x70,0x68,0xC2,0x0C,0x68,0x15,0x92,0xAC,0x32,0x60,0x20,
0x5D,0x26,0xD2,0xDA,0xC9,0xD4,0xBB,0x12,0xBB,0xAB,0x75,0x54,0xF3,0x56,0xCB,0x15,
0x86,0x2F,0x2D,0x85,0xEA,0x8A,0x40,0xE7,0xA6,0x22,0xB1,0x3E,0x6D,0x18,0xC6,0x2C,
0x73,0x46,0x8C,0xC0,0x6E,0xCE,0xD2,0x0D,0x64,0xD2,0xD3,0x66,0x97,0x7B,0xAF,0xDA,
0x52,0x50,0x0A,0x6F,0x85,0xBC,0x8A,0xAB,0x6A,0xEF,0x65,0x72,0x44,0x88,0xE5,0xC9,
0x15,0x98,0x19,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

int main(void)
{
	isomsg m;
isodef pbsmg20[] = {
    /*000*/ {ISO_NUMERIC, 0, 4, "Message Type Indicator"},
    /*001*/ {ISO_BITMAP, 0, 16, "Bitmap"},
    /*002*/ {ISO_NUMERIC, 2, 19, "Primary Account number"},
    /*003*/ {ISO_NUMERIC, 0, 6, "Processing Code"},
    /*004*/ {ISO_NUMERIC, 0, 12, "Amount, Transaction"},
    /*005*/ {ISO_NUMERIC, 0, 12, "Amount, Reconciliation"},
    /*006*/ {ISO_NUMERIC, 0, 12, "Amount, Cardholder billing"},
    /*007*/ {ISO_NUMERIC, 0, 10, "Date and time, transmission"},
    /*008*/ {ISO_NUMERIC, 0, 8, "Amount, Cardholder billing fee"},
    /*009*/ {ISO_NUMERIC, 0, 8, "Conversion rate, Reconciliation"},
    /*010*/ {ISO_NUMERIC, 0, 8, "Conversion rate, Cardholder billing"},
    /*011*/ {ISO_NUMERIC, 0, 6, "Systems trace audit number"},
    /*012*/ {ISO_NUMERIC, 0, 12, "Date and time, Local transaction"},
    /*013*/ {ISO_NUMERIC, 0, 4, "Date, Effective"},
    /*014*/ {ISO_NUMERIC, 0, 4, "Date, Expiration"},
    /*015*/ {ISO_NUMERIC, 0, 6, "Date, Settlement"},
    /*016*/ {ISO_NUMERIC, 0, 4, "Date, Conversion"},
    /*017*/ {ISO_NUMERIC, 0, 4, "Date, Capture"},
    /*018*/ {ISO_NUMERIC, 0, 4, "Merchant type"},
    /*019*/ {ISO_NUMERIC, 0, 3, "Country code, Acquiring institution"},
    /*020*/ {ISO_NUMERIC, 0, 3, "Country code, Primary account number"},
    /*021*/ {ISO_NUMERIC, 0, 3, "Country code, Forwarding institution"},
    /*022*/ {ISO_ALPHANUMERIC, 0, 12, "Point of service data code"},
    /*023*/ {ISO_NUMERIC, 0, 3, "Card sequence number"},
    /*024*/ {ISO_NUMERIC, 0, 3, "Function code"},
    /*025*/ {ISO_NUMERIC, 0, 4, "Message reason code"},
    /*026*/ {ISO_NUMERIC, 0, 4, "Card acceptor business code"},
    /*027*/ {ISO_NUMERIC, 0, 1, "Approval code length"},
    /*028*/ {ISO_NUMERIC, 0, 6, "Date, Reconciliation"},
    /*029*/ {ISO_NUMERIC, 0, 3, "Reconciliation indicator"},
    /*030*/ {ISO_NUMERIC, 0, 24, "Amounts, original"},
    /*031*/ {ISO_ALPHANUMERIC, 2, 99, "Acquirer reference data"},
    /*032*/ {ISO_NUMERIC, 2, 11, "Acquirer institution identification code"},
    /*033*/ {ISO_NUMERIC, 2, 11, "Forwarding institution identification code"},
    /*034*/ {ISO_ALPHANUMERIC, 2, 28, "Primary account number, extended"},
    /*035*/ {ISO_ALPHANUMERIC, 2, 37, "Track 2 data"},
    /*036*/ {ISO_ALPHANUMERIC, 3, 104, "Track 3 data"},
    /*037*/ {ISO_ALPHANUMERIC, 0, 12, "Retrieval reference number"},
    /*038*/ {ISO_ALPHANUMERIC, 0, 6, "Approval code"},
    /*039*/ {ISO_NUMERIC, 0, 3, "Action code"},
    /*040*/ {ISO_NUMERIC, 0, 3, "Service code"},
    /*041*/ {ISO_ALPHANUMERIC, 0, 8, "Card acceptor terminal identification"},
    /*042*/ {ISO_ALPHANUMERIC, 0, 15, "Card acceptor identification code"},
    /*043*/ {ISO_ALPHANUMERIC, 2, 99, "Card acceptor name/location"},
    /*044*/ {ISO_ALPHANUMERIC, 2, 99, "Additional response data"},
    /*045*/ {ISO_ALPHANUMERIC, 2, 76, "Track 1 data"},
    /*046*/ {ISO_ALPHANUMERIC, 3, 204, "Amounts, Fees"},
    /*047*/ {ISO_ALPHANUMERIC, 3, 999, "Additional data - national"},
    /*048*/ {ISO_ALPHANUMERIC, 3, 999, "Additional data - private"},
    /*049*/ {ISO_ALPHANUMERIC, 0, 3, "Currency code, Transaction"},
    /*050*/ {ISO_ALPHANUMERIC, 0, 3, "Currency code, Reconciliation"},
    /*051*/ {ISO_ALPHANUMERIC, 0, 3, "Currency code, Cardholder billing"},
    /*052*/ {ISO_BINARY, 0, 8, "Personal identification number, PIN) data"},
    /*053*/ {ISO_BINARY, 2, 48, "Security related control information"},
    /*054*/ {ISO_ALPHANUMERIC, 3, 120, "Amounts, additional"},
    /*055*/ {ISO_BINARY, 3, 255, "IC card system related data"},
    /*056*/ {ISO_BINARY, 3, 255, "Original data elements"},
    /*057*/ {ISO_NUMERIC, 0, 3, "Authorization life cycle code"},
    /*058*/ {ISO_NUMERIC, 2, 11, "Authorizing agent institution Id Code"},
    /*059*/ {ISO_ALPHANUMERIC, 3, 999, "Transport data"},
    /*060*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for national use"},
    /*061*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for national use"},
    /*062*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for private use"},
    /*063*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for private use"},
    /*064*/ {ISO_BINARY, 0, 8, "Message authentication code field"},
    /*065*/ {ISO_BINARY, 0, 8, "Reserved for ISO use"},
    /*066*/ {ISO_ALPHANUMERIC, 3, 204, "Amounts, original fees"},
    /*067*/ {ISO_NUMERIC, 0, 2, "Extended payment data"},
    /*068*/ {ISO_NUMERIC, 0, 3, "Country code, receiving institution"},
    /*069*/ {ISO_NUMERIC, 0, 3, "Country code, settlement institution"},
    /*070*/ {ISO_NUMERIC, 0, 3, "Country code, authorizing agent Inst."},
    /*071*/ {ISO_NUMERIC, 0, 8, "Message number"},
    /*072*/ {ISO_ALPHANUMERIC, 3, 999, "Data record"},
    /*073*/ {ISO_NUMERIC, 0, 6, "Date, action"},
    /*074*/ {ISO_NUMERIC, 0, 10, "Credits, number"},
    /*075*/ {ISO_NUMERIC, 0, 10, "Credits, reversal number"},
    /*076*/ {ISO_NUMERIC, 0, 10, "Debits, number"},
    /*077*/ {ISO_NUMERIC, 0, 10, "Debits, reversal number"},
    /*078*/ {ISO_NUMERIC, 0, 10, "Transfer, number"},
    /*079*/ {ISO_NUMERIC, 0, 10, "Transfer, reversal number"},
    /*080*/ {ISO_NUMERIC, 0, 10, "Inquiries, number"},
    /*081*/ {ISO_NUMERIC, 0, 10, "Authorizations, number"},
    /*082*/ {ISO_NUMERIC, 0, 10, "Inquiries, reversal number"},
    /*083*/ {ISO_NUMERIC, 0, 10, "Payments, number"},
    /*084*/ {ISO_NUMERIC, 0, 10, "Payments, reversal number"},
    /*085*/ {ISO_NUMERIC, 0, 10, "Fee collections, number"},
    /*086*/ {ISO_NUMERIC, 0, 16, "Credits, amount"},
    /*087*/ {ISO_NUMERIC, 0, 16, "Credits, reversal amount"},
    /*088*/ {ISO_NUMERIC, 0, 16, "Debits, amount"},
    /*089*/ {ISO_NUMERIC, 0, 16, "Debits, reversal amount"},
    /*090*/ {ISO_NUMERIC, 0, 10, "Authorizations, reversal number"},
    /*091*/ {ISO_NUMERIC, 0, 3, "Country code, transaction Dest. Inst."},
    /*092*/ {ISO_NUMERIC, 0, 3, "Country code, transaction Orig. Inst."},
    /*093*/ {ISO_NUMERIC, 2, 11, "Transaction Dest. Inst. Id code"},
    /*094*/ {ISO_NUMERIC, 2, 11, "Transaction Orig. Inst. Id code"},
    /*095*/ {ISO_ALPHANUMERIC, 2, 99, "Card issuer reference data"},
    /*096*/ {ISO_BINARY, 3, 999, "Key management data"},
    /*097*/ {ISO_NUMERIC, 0, 1+16, "Amount, Net reconciliation"}, /* was ISO_AMOUNT */
    /*098*/ {ISO_ALPHANUMERIC, 0, 25, "Payee"},
    /*099*/ {ISO_ALPHANUMERIC, 2, 11, "Settlement institution Id code"},
    /*100*/ {ISO_NUMERIC, 2, 11, "Receiving institution Id code"},
    /*101*/ {ISO_ALPHANUMERIC, 2, 17, "File name"},
    /*102*/ {ISO_ALPHANUMERIC, 2, 28, "Account identification 1"},
    /*103*/ {ISO_ALPHANUMERIC, 2, 28, "Account identification 2"},
    /*104*/ {ISO_ALPHANUMERIC, 3, 100, "Transaction description"},
    /*105*/ {ISO_NUMERIC, 0, 16, "Credits, Chargeback amount"},
    /*106*/ {ISO_NUMERIC, 0, 16, "Debits, Chargeback amount"},
    /*107*/ {ISO_NUMERIC, 0, 10, "Credits, Chargeback number"},
    /*108*/ {ISO_NUMERIC, 0, 10, "Debits, Chargeback number"},
    /*109*/ {ISO_ALPHANUMERIC, 2, 84, "Credits, Fee amounts"},
    /*110*/ {ISO_ALPHANUMERIC, 2, 84, "Debits, Fee amounts"},
    /*111*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for ISO use"},
    /*112*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for ISO use"},
    /*113*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for ISO use"},
    /*114*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for ISO use"},
    /*115*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for ISO use"},
    /*116*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for national use"},
    /*117*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for national use"},
    /*118*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for national use"},
    /*119*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for national use"},
    /*120*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for national use"},
    /*121*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for national use"},
    /*122*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for national use"},
    /*123*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for private use"},
    /*124*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for private use"},
    /*125*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for private use"},
    /*126*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for private use"},
    /*127*/ {ISO_ALPHANUMERIC, 3, 999, "Reserved for private use"},
    /*128*/ {ISO_BINARY, 0, 8, "Message authentication code field"}
};


	int i, len;
	char *buf;
	FILE *fp;

	init_message(&m);	
	m.bmp_flag = BMP_BINARY;

	buf = (char *) calloc(4096, sizeof(char));
	printf("\n--- Authorisation Request ---\n");
	unpack_message(&m, pbsmg20, authreq);
	for (i = 0; i <= 128; i++) {
		if (m.fld[i] != NULL) {
			printf("field #%d = %s\n", i, m.fld[i]);
		}
	}
	len = pack_message(&m, pbsmg20, buf);
	if (!memcmp(authreq, buf, len)) {
		printf("Packed data equals original data\n");
	} else {
		printf("Packed data DOES NOT equal original data\n");
	}
	fp = fopen("c1-auth-req.bin", "wb");
	fwrite(buf, sizeof(char), len, fp);
	fclose(fp);
	free_message(&m);
	free(buf);

	buf = (char *) calloc(4096, sizeof(char));
	printf("\n--- Authorisation Response ---\n");
	unpack_message(&m, pbsmg20, authresp);
	for (i = 0; i <= 128; i++) {
		if (m.fld[i] != NULL) {
			printf("field #%d = %s\n", i, m.fld[i]);
		}
	}
	len = pack_message(&m, pbsmg20, buf);
	if (!memcmp(authresp, buf, len)) {
		printf("Packed data equals original data\n");
	} else {
		printf("Packed data DOES NOT equal original data\n");
	}
	fp = fopen("c2-auth-resp.bin", "wb");
	fwrite(buf, sizeof(char), 4096, fp);
	fclose(fp);
	free_message(&m);
	free(buf);

	buf = (char *) calloc(4096, sizeof(char));
	printf("\n--- Capture Request ---\n");
	unpack_message(&m, pbsmg20, capreq);
	for (i = 0; i <= 128; i++) {
		if (m.fld[i] != NULL) {
			printf("field #%d = %s\n", i, m.fld[i]);
		}
	}
	len = pack_message(&m, pbsmg20, buf);
	if (!memcmp(capreq, buf, len)) {
		printf("Packed data equals original data\n");
	} else {
		printf("Packed data DOES NOT equal original data\n");
	}
	fp = fopen("c3-cap-req.bin", "wb");
	fwrite(buf, sizeof(char), 4096, fp);
	free_message(&m);
	fclose(fp);
	free(buf);

	buf = (char *) calloc(4096, sizeof(char));
	printf("\n--- Capture Response ---\n");
	unpack_message(&m, pbsmg20, capresp);
	for (i = 0; i <= 128; i++) {
		if (m.fld[i] != NULL) {
			printf("field #%d = %s\n", i, m.fld[i]);
		}
	}
	len = pack_message(&m, pbsmg20, buf);
	if (!memcmp(capresp, buf, len)) {
		printf("Packed data equals original data\n");
	} else {
		printf("Packed data DOES NOT equal original data\n");
	}
	fp = fopen("c4-cap-resp.bin", "wb");
	fwrite(buf, sizeof(char), 4096, fp);
	fclose(fp);
	free(buf);

	free_message(&m);

	return 0;
}
